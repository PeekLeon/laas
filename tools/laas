#!/usr/bin/env bash
# set -euo pipefail

declare -A colors=(
  [black]="\033[30m"
  [red]="\033[31m"
  [green]="\033[32m"
  [yellow]="\033[33m"
  [blue]="\033[34m"
  [magenta]="\033[35m"
  [cyan]="\033[36m"
  [white]="\033[37m"
  [reset]="\033[0m"
)

update(){
  # Liste des repos à surveiller
  # Format: "nom=repoGitHub"
  declare -A repos=(
    [YQ]=mikefarah/yq
    [JQ]=jqlang/jq
    [KUBECONFORM]=yannh/kubeconform
    [MC]=minio/mc
    [STARSHIP]=starship/starship
    [HELM]=helm/helm
    [CODE_SERVER]=coder/code-server
  )

  # Fichier de sortie
  OUTFILE="${LAAS_PROJECT_DIR%/}/.laas-config/versions.laas"
  : > "$OUTFILE"

  echo "# $(date)" >> "$OUTFILE"
  echo "LAAS_VERSION=$1" | tee -a "$OUTFILE"
  for name in "${!repos[@]}"; do
    repo="${repos[$name]}"
    version=$(curl -s https://api.github.com/repos/$repo/releases/latest \
              | grep tag_name | cut -d '"' -f4)
    echo "${name}_VERSION=$version" | tee -a "$OUTFILE"
  done

  version=$(curl -s https://api.github.com/repos/ohmyzsh/ohmyzsh/commits/master \
            | grep sha | head -n 1 | cut -d '"' -f4)
  echo "OHMYZSH_VERSION=$version" | tee -a "$OUTFILE"

  version=$(curl -L -s https://dl.k8s.io/release/stable.txt)
  echo "KUBECTL_VERSION=$version" | tee -a "$OUTFILE"

  apt update
  version=$(apt-cache madison docker-ce | grep -v beta | head -n1 | awk '{print $3}')
  echo "DOCKER_VERSION=$version" | tee -a "$OUTFILE"

  compare_versions
}

info(){
  cat /.laas-config/versions.laas
}

usage(){
  echo "Usage: \n"
  echo "$0 info - Get versions used in laas"
  echo "$0 update - Create versions.laas file"
}

#!/bin/bash

compare_versions() {
  file2="${LAAS_PROJECT_DIR%/}/.laas-config/versions.laas"
  file1=/.laas-config/versions.laas
  local change=0
  # Charger les variables des fichiers dans des tableaux associatifs
  declare -A vars1 vars2

  # Ignorer les lignes qui commencent par #
  while IFS='=' read -r key value; do
    [[ "$key" =~ ^#|^$ ]] && continue
    vars1["$key"]="$value"
  done < "$file1"

  while IFS='=' read -r key value; do
    [[ "$key" =~ ^#|^$ ]] && continue
    vars2["$key"]="$value"
  done < "$file2"

  echo "Comparing $file1 → $file2"
  echo

  # Vérifier chaque variable du fichier 1
  for key in "${!vars1[@]}"; do
    if [[ -v vars2["$key"] ]]; then
      if [[ "${vars1[$key]}" == "${vars2[$key]}" ]]; then
        echo -e "$key : ${colors[blue]} no change (${vars2[$key]}) ${colors[reset]}"
      else
        echo -e "$key : ${colors[green]} updated (${vars1[$key]} → ${vars2[$key]}) ${colors[reset]}"
        change=$((change + 1))
      fi
    else
      echo -e "$key : ${colors[red]} removed ${colors[reset]}"
      change=$((change + 1))
    fi
  done
  
  # Vérifier les nouvelles variables dans file2
  for key in "${!vars2[@]}"; do
    if [[ ! -v vars1["$key"] ]]; then
      echo "$key : new (${vars2[$key]})"
    fi
  done
}

compare_versions_md() {
  file2="${LAAS_PROJECT_DIR%/}/.laas-config/versions.laas"
  file1=/.laas-config/versions.laas
  local change=0
  declare -A vars1 vars2

  # Charger les variables des fichiers dans des tableaux associatifs
  while IFS='=' read -r key value; do
    [[ "$key" =~ ^#|^$ ]] && continue
    vars1["$key"]="$value"
  done < "$file1"

  while IFS='=' read -r key value; do
    [[ "$key" =~ ^#|^$ ]] && continue
    vars2["$key"]="$value"
  done < "$file2"

  # Récupérer la version LAAS
  old_laas="${vars1[LAAS_VERSION]}"
  new_laas="${vars2[LAAS_VERSION]}"
  echo -e "\n\n## LAAS $old_laas => **$new_laas**\n"
  
  # En-tête du tableau Markdown
  echo "| App | Status | Old Value | New Value |"
  echo "|-----|--------|-----------|-----------|"

  # Vérifier chaque variable du fichier 1 (sauf LAAS_VERSION)
  for key in "${!vars1[@]}"; do
    [[ "$key" == "LAAS_VERSION" ]] && continue
    if [[ -v vars2["$key"] ]]; then
      if [[ "${vars1[$key]}" == "${vars2[$key]}" ]]; then
        echo "| ${key%_VERSION} | No change | ${vars1[$key]} | ${vars2[$key]} |"
      else
        echo "| ${key%_VERSION} | Updated | ${vars1[$key]} | ${vars2[$key]} |"
        change=$((change + 1))
      fi
    else
      echo "| ${key%_VERSION} | Removed | ${vars1[$key]} | - |"
      change=$((change + 1))
    fi
  done

  # Vérifier les nouvelles variables dans file2 (sauf LAAS_VERSION)
  for key in "${!vars2[@]}"; do
    [[ "$key" == "LAAS_VERSION" ]] && continue
    if [[ ! -v vars1["$key"] ]]; then
      echo "| ${key%_VERSION} | New | - | ${vars2[$key]} |"
    fi
  done
}

set_changelog(){
  md=$(compare_versions_md)
  { echo "${md}"; cat ${LAAS_PROJECT_DIR%/}/CHANGELOG.md; } > tmp && mv tmp ${LAAS_PROJECT_DIR%/}/CHANGELOG.md
}

if [ -z "$1" ]; then
  usage
  exit 1
else
  case "$1" in
    update)
      update $2
      ;;
    info)
      info
      ;;
    compare_versions)
      compare_versions
      ;;
    compare_versions_md)
      compare_versions_md
      ;;
    set_changelog)
      set_changelog
      ;;
    *)
      echo "Unknown option: $1"
      usage
      ;;
    esac
fi
